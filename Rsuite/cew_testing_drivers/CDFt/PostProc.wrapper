#!/bin/csh
#Wrapper for the R script used for post-processing options

module load nco
module load gcp 
set echo 

#input file directory
set INDIR = "/work/cew/downscaled/NOAA-GFDL/MPI-ESM-LR/rcp85/day/atmos/day/r1i1p1/v20111014/RRtxp1-CDFt-A38L01K00/tasmax/RR/OneD/v20140108/"
set VAR = 'tasmax'
set KFOLD = '0'
set METHOD = 'compare.correct'
set TMASKFILE = '/archive/esd/PROJECTS/DOWNSCALING/3ToThe5th/masks/timemasks/maskdays_bymonth_20060101-20991231.nc'
#set lons = $5
#set lone = $6
set MASKDIR = '/home/cew/Code/testing/QCMask.test/'
set COMPDIR = '/home/cew/Code/testing/compare.test/'

#set region_name

#set post-processing directory
set FUDGEROOT = "/home/cew/Code/fudge2014/"

#output file directory

set lons=300
set lone=300
set var='tasmax'

#set index = seq $lons $lone
#mkdir "$INDIR/../../PostProcess/" #Will this throw an error if the directory already exists? 
#For each latitude index (note: this is seriously going to be thrown off if we ever do the 3-block chunks:
#set index = $lons
#while ($index <= $lone)
# echo "index $index"
# set INFILE = ( ls $INDIR . | grep "$index" ) 
# echo $INFILE
# set SUFFIX = (grep -v ".nc" $INFILE)
# set INFILE = "$INDIR/$INFILE"
# set OUTDIR = "$INDIR/../../PostProcess/"
 set OUTDIR = "/home/cew/Code/testing/"
# set datapath = ""
# set OUTFILE = "$OUTDIR/${METHOD}_${SUFFIX}.nc"
# set QCFILE = 'ls $MASKDIR | grep "$index"'
# set QCMASK = "$MASKDIR/$QCFILE"
# set DATAFILE = (ls $COMPDIR | grep "$index")
# set QCDATA = "$COMPDIR/$DATAFILE"
# ncks -x -v $var $INFILE "$OUTDIR/$OUTFILE"

# set commandstr = "postProc.Driver(in.file=$INFILE, var=$VAR, k.fold=$KFOLD, postproc.method=$METHOD, out.dir=$OUTDIR, postproc.outfile=$OUTFILE, tmask.infile=$TMASKFILE, qc.mask.path=$QCMASK, qc.data.path=$QCDATA)"

# set commandstr = "\'postProc.Driver(in.dir='$INDIR', var='$VAR', k.fold=$KFOLD, postproc.method='$METHOD', out.dir='$OUTDIR', postproc.outdir='$OUTDIR', tmask.infile='$TMASKFILE', qc.mask.path='$MASKDIR', qc.data.path='$COMPDIR', lons=$lons, lone=$lone)\'"
 set commandstr2 = "postProc.Driver(in.dir='$INDIR', var='$VAR', k.fold=$KFOLD, postproc.method='$METHOD', out.dir='$OUTDIR', postproc.outdir='$OUTDIR', tmask.infile='$TMASKFILE', qc.mask.path='$MASKDIR', qc.data.path='$COMPDIR', lons=$lons, lone=$lone)"

set commandstr1 = "source('$FUDGEROOT/utils/pp/CallPostProcMethod.R')"

 #Rscript --verbose -e "'source(\'$FUDGEROOT/utils/pp/CallPostProcMethod.R\')'" -e $commandstr
Rscript --verbose -e "$commandstr1" -e "$commandstr2"
#Rscript --verbose -e "$commandstr2"

wait
# set index = $index + 1
#end

#Note that this means processOutput also needs to contain the sourcing of the FUDGE utils in its code, 
#as well as sourcing of the FUDGE libraries.

#Finally, call cattool on the final output
#cattool -i $OUTDIR $SUFFIX "$OUTDIR/$METHOD_${SUFFIX}/" $region_name

#INDIR MINIFILEPREFIX OFILE AUXDIR region=region_name"
#I do not have a clear idea what is meant by AUXDIR

#Rscript --verbose -e source('/home/cew/Code/fudge2014//utils/pp/CallPostProcMethod.R') -e postProc.Driver(in.dir='/work/cew/downscaled/NOAA-GFDL/MPI-ESM-LR/rcp85/day/atmos/day/r1i1p1/v20111014/RRtxp1-CDFt-A38L01K00/tasmax/RR/OneD/v20140108/', var='tasmax', k.fold=0, postproc.method='compare.correct', out.dir='/home/cew/Code/testing/', postproc.outdir='/home/cew/Code/testing/', tmask.infile='/archive/esd/PROJECTS/DOWNSCALING/3ToThe5th/masks/timemasks/maskdays_bymonth_20060101-20991231.nc', qc.mask.path='/home/cew/Code/testing/QCMask.test/', qc.data.path='/home/cew/Code/testing/compare.test/', lons=300, lone=300)


#'/usr/local/x64/R/R-2.15.2/lib64/R/bin/R --slave --no-restore -e source('/home/cew/Code/fudge2014//utils/pp/CallPostProcMethod.R') -e postProc.Driver(in.dir='/work/cew/downscaled/NOAA-GFDL/MPI-ESM-LR/rcp85/day/atmos/day/r1i1p1/v20111014/RRtxp1-CDFt-A38L01K00/tasmax/RR/OneD/v20140108/', --args var='tasmax', k.fold=0, postproc.method='compare.correct', out.dir='/home/cew/Code/testing/', postproc.outdir='/home/cew/Code/testing/', tmask.infile='/archive/esd/PROJECTS/DOWNSCALING/3ToThe5th/masks/timemasks/maskdays_bymonth_20060101-20991231.nc', qc.mask.path='/home/cew/Code/testing/QCMask.test/', qc.data.path='/home/cew/Code/testing/compare.test/', lons=300,'

	
	
